name: Diff Territory Scheduler

on:
  schedule:
    - cron: '5 0 * * *'      # daily at 00:05 UTC
    - cron: '10 0 * * 1'     # weekly Monday at 00:10 UTC
  workflow_dispatch: {}

jobs:
  call-diff-territory:
    runs-on: ubuntu-latest
    steps:
      - name: Call diff-territory Edge Function
        env:
          FUNCTION_URL: "https://${{ secrets.VITE_SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/diff-territory"
          FUNCTION_AUTH_HEADER: ${{ secrets.FUNCTION_AUTH_HEADER }}
        run: |
          set -euo pipefail
          echo "Calling diff-territory at $FUNCTION_URL"
          if [ -n "${FUNCTION_AUTH_HEADER:-}" ]; then
            http_status=$(curl -sS -o /dev/stderr -w "%{http_code}" -X POST "$FUNCTION_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: $FUNCTION_AUTH_HEADER" \
              -d '{}' ) || true
          else
            http_status=$(curl -sS -o /dev/stderr -w "%{http_code}" -X POST "$FUNCTION_URL" \
              -H "Content-Type: application/json" \
              -d '{}' ) || true
          fi
          echo "HTTP status: $http_status"
          if [ "$http_status" -ge 400 ]; then
            echo "Function returned error status $http_status"
            exit 1
          fi
